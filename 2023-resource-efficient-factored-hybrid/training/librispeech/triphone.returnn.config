#!rnn.py


import numpy as np

from returnn.tf.util.data import Dim

__time_tag__ = Dim(dimension=None, kind=Dim.Types.Spatial, description="time")


batch_size = 11000
cache_size = "0"
chunking = "400:200"
cleanup_old_models = {"keep": [550, 600], "keep_best_n": 3}
debug_print_layer_output_template = True
dev = {
    "class": "ExternSprintDataset",
    "partitionEpoch": 1,
    "sprintConfigStr": "--config=rasr.dev.config --*.LOGFILE=nn-trainer.dev.log --*.TASK=1",
    "sprintTrainerExecPath": "/u/mgunz/src/fh_rasr/arch/linux-x86_64-standard/nn-trainer.linux-x86_64-standard",
}
device = "gpu"
extern_data = {
    "centerState": {
        "available_for_inference": True,
        "dim": 252,
        "dtype": "int32",
        "same_dim_tags_as": {"T": __time_tag__},
        "sparse": True,
    },
    "classes": {
        "available_for_inference": True,
        "dim": 444528,
        "dtype": "int32",
        "same_dim_tags_as": {"T": __time_tag__},
        "sparse": True,
    },
    "data": {"dim": 50, "same_dim_tags_as": {"T": __time_tag__}},
    "futureLabel": {
        "available_for_inference": True,
        "dim": 42,
        "dtype": "int32",
        "same_dim_tags_as": {"T": __time_tag__},
        "sparse": True,
    },
    "pastLabel": {
        "available_for_inference": True,
        "dim": 42,
        "dtype": "int32",
        "same_dim_tags_as": {"T": __time_tag__},
        "sparse": True,
    },
}
gradient_noise = 0.0
learning_rate_control = "constant"
learning_rate_file = "lr.log"
learning_rates = [
    1.9564197530864198e-05,
    2.1461728395061728e-05,
    2.335925925925926e-05,
    2.525679012345679e-05,
    2.715432098765432e-05,
    2.905185185185185e-05,
    3.094938271604938e-05,
    3.284691358024691e-05,
    3.474444444444444e-05,
    3.664197530864197e-05,
    3.85395061728395e-05,
    4.043703703703703e-05,
    4.233456790123456e-05,
    4.42320987654321e-05,
    4.612962962962963e-05,
    4.802716049382716e-05,
    4.9924691358024695e-05,
    5.1822222222222224e-05,
    5.3719753086419754e-05,
    5.5617283950617284e-05,
    5.7514814814814814e-05,
    5.9412345679012344e-05,
    6.130987654320987e-05,
    6.32074074074074e-05,
    6.510493827160493e-05,
    6.700246913580246e-05,
    6.89e-05,
    7.079753086419752e-05,
    7.269506172839505e-05,
    7.459259259259258e-05,
    7.649012345679011e-05,
    7.838765432098764e-05,
    8.028518518518519e-05,
    8.218271604938272e-05,
    8.408024691358025e-05,
    8.597777777777778e-05,
    8.787530864197531e-05,
    8.977283950617284e-05,
    9.167037037037037e-05,
    9.35679012345679e-05,
    9.546543209876543e-05,
    9.736296296296296e-05,
    9.926049382716049e-05,
    0.00010115802469135802,
    0.00010305555555555555,
    0.00010495308641975308,
    0.00010685061728395061,
    0.00010874814814814814,
    0.00011064567901234567,
    0.0001125432098765432,
    0.00011444074074074073,
    0.00011633827160493826,
    0.00011823580246913579,
    0.00012013333333333333,
    0.00012203086419753086,
    0.00012392839506172838,
    0.00012582592592592592,
    0.00012772345679012344,
    0.00012962098765432098,
    0.0001315185185185185,
    0.00013341604938271604,
    0.00013531358024691356,
    0.0001372111111111111,
    0.00013910864197530862,
    0.00014100617283950616,
    0.0001429037037037037,
    0.00014480123456790122,
    0.00014669876543209876,
    0.00014859629629629628,
    0.00015049382716049382,
    0.00015239135802469134,
    0.00015428888888888888,
    0.0001561864197530864,
    0.00015808395061728394,
    0.00015998148148148146,
    0.000161879012345679,
    0.00016377654320987652,
    0.00016567407407407406,
    0.00016757160493827158,
    0.00016946913580246912,
    0.00017136666666666664,
    0.00017326419753086418,
    0.0001751617283950617,
    0.00017705925925925924,
    0.00017895679012345676,
    0.0001808543209876543,
    0.00018275185185185185,
    0.00018464938271604936,
    0.0001865469135802469,
    0.00018844444444444442,
    0.00019034197530864197,
    0.00019223950617283948,
    0.00019413703703703703,
    0.00019603456790123454,
    0.0001979320987654321,
    0.0001998296296296296,
    0.00020172716049382715,
    0.00020362469135802466,
    0.0002055222222222222,
    0.00020741975308641972,
    0.00020931728395061727,
    0.00021121481481481478,
    0.00021311234567901233,
    0.00021500987654320984,
    0.00021690740740740739,
    0.0002188049382716049,
    0.00022070246913580245,
    0.0002226,
    0.0002244975308641975,
    0.00022639506172839505,
    0.00022829259259259257,
    0.0002301901234567901,
    0.00023208765432098763,
    0.00023398518518518517,
    0.00023588271604938269,
    0.00023778024691358023,
    0.00023967777777777775,
    0.0002415753086419753,
    0.0002434728395061728,
    0.00024537037037037035,
    0.00024726790123456784,
    0.0002491654320987654,
    0.0002510629629629629,
    0.00025296049382716047,
    0.00025485802469135796,
    0.0002567555555555555,
    0.00025865308641975305,
    0.0002605506172839506,
    0.0002624481481481481,
    0.0002643456790123456,
    0.00026624320987654317,
    0.0002681407407407407,
    0.0002700382716049382,
    0.00027193580246913574,
    0.0002738333333333333,
    0.00027573086419753083,
    0.0002776283950617283,
    0.00027952592592592586,
    0.0002814234567901234,
    0.00028332098765432095,
    0.00028521851851851844,
    0.000287116049382716,
    0.0002890135802469135,
    0.00029091111111111107,
    0.00029280864197530856,
    0.0002947061728395061,
    0.00029660370370370365,
    0.0002985012345679012,
    0.0003003987654320987,
    0.0003022962962962962,
    0.00030419382716049376,
    0.0003060913580246913,
    0.00030798888888888885,
    0.00030988641975308634,
    0.0003117839506172839,
    0.00031368148148148143,
    0.00031557901234567897,
    0.00031747654320987646,
    0.000319374074074074,
    0.00032127160493827155,
    0.0003231691358024691,
    0.0003250666666666666,
    0.0003269641975308641,
    0.00032886172839506167,
    0.0003307592592592592,
    0.0003326567901234567,
    0.00033455432098765424,
    0.0003364518518518518,
    0.00033834938271604933,
    0.0003402469135802468,
    0.00034214444444444436,
    0.0003440419753086419,
    0.00034593950617283945,
    0.000347837037037037,
    0.0003497345679012345,
    0.00035163209876543203,
    0.00035352962962962957,
    0.0003554271604938271,
    0.0003573246913580246,
    0.00035922222222222215,
    0.0003611197530864197,
    0.00036301728395061723,
    0.0003649148148148147,
    0.00036681234567901227,
    0.0003687098765432098,
    0.00037060740740740735,
    0.00037250493827160484,
    0.0003744024691358024,
    0.00037629999999999993,
    0.0003781975308641975,
    0.00038009506172839496,
    0.0003819925925925925,
    0.00038389012345679005,
    0.0003857876543209876,
    0.00038768518518518514,
    0.00038958271604938263,
    0.00039148024691358017,
    0.0003933777777777777,
    0.00039527530864197526,
    0.00039717283950617275,
    0.0003990703703703703,
    0.00040096790123456783,
    0.0004028654320987654,
    0.00040476296296296287,
    0.0004066604938271604,
    0.00040855802469135795,
    0.0004104555555555555,
    0.000412353086419753,
    0.00041425061728395053,
    0.0004161481481481481,
    0.0004180456790123456,
    0.0004199432098765431,
    0.00042184074074074065,
    0.0004237382716049382,
    0.00042563580246913574,
    0.0004275333333333333,
    0.00042943086419753077,
    0.0004313283950617283,
    0.00043322592592592586,
    0.0004351234567901234,
    0.0004370209876543209,
    0.00043891851851851843,
    0.000440816049382716,
    0.0004427135802469135,
    0.000444611111111111,
    0.00044650864197530855,
    0.0004484061728395061,
    0.00045030370370370364,
    0.00045220123456790113,
    0.0004540987654320987,
    0.0004559962962962962,
    0.00045789382716049376,
    0.00045979135802469125,
    0.0004616888888888888,
    0.00046358641975308634,
    0.0004654839506172839,
    0.0004673814814814814,
    0.0004692790123456789,
    0.00047117654320987646,
    0.000473074074074074,
    0.00047497160493827154,
    0.00047686913580246903,
    0.0004787666666666666,
    0.0004806641975308641,
    0.00048256172839506166,
    0.00048445925925925915,
    0.0004863567901234567,
    0.00048825432098765424,
    0.0004901518518518518,
    0.0004920493827160493,
    0.0004939469135802468,
    0.0004958444444444444,
    0.0004977419753086419,
    0.0004996395061728394,
    0.000501537037037037,
    0.0005034345679012345,
    0.0005053320987654321,
    0.0005072296296296296,
    0.0005091271604938272,
    0.0005110246913580247,
    0.0005129222222222221,
    0.0005148197530864197,
    0.0005167172839506172,
    0.0005186148148148148,
    0.0005205123456790123,
    0.0005224098765432098,
    0.0005243074074074074,
    0.0005262049382716049,
    0.0005281024691358024,
    0.00053,
    0.0005281024691358025,
    0.0005262049382716049,
    0.0005243074074074074,
    0.0005224098765432098,
    0.0005205123456790123,
    0.0005186148148148148,
    0.0005167172839506172,
    0.0005148197530864197,
    0.0005129222222222223,
    0.0005110246913580247,
    0.0005091271604938272,
    0.0005072296296296296,
    0.0005053320987654321,
    0.0005034345679012346,
    0.000501537037037037,
    0.0004996395061728395,
    0.0004977419753086419,
    0.0004958444444444444,
    0.0004939469135802469,
    0.0004920493827160493,
    0.0004901518518518518,
    0.0004882543209876543,
    0.00048635679012345675,
    0.00048445925925925926,
    0.0004825617283950617,
    0.0004806641975308642,
    0.00047876666666666663,
    0.00047686913580246914,
    0.0004749716049382716,
    0.00047307407407407405,
    0.0004711765432098765,
    0.000469279012345679,
    0.0004673814814814815,
    0.00046548395061728393,
    0.0004635864197530864,
    0.00046168888888888885,
    0.00045979135802469136,
    0.0004578938271604938,
    0.00045599629629629627,
    0.0004540987654320988,
    0.00045220123456790124,
    0.0004503037037037037,
    0.00044840617283950615,
    0.0004465086419753086,
    0.0004446111111111111,
    0.0004427135802469136,
    0.00044081604938271603,
    0.00043891851851851854,
    0.000437020987654321,
    0.00043512345679012345,
    0.0004332259259259259,
    0.00043132839506172837,
    0.0004294308641975309,
    0.00042753333333333334,
    0.0004256358024691358,
    0.00042373827160493825,
    0.0004218407407407407,
    0.0004199432098765432,
    0.00041804567901234567,
    0.00041614814814814813,
    0.00041425061728395064,
    0.0004123530864197531,
    0.00041045555555555555,
    0.000408558024691358,
    0.00040666049382716046,
    0.000404762962962963,
    0.00040286543209876543,
    0.0004009679012345679,
    0.0003990703703703704,
    0.0003971728395061728,
    0.0003952753086419753,
    0.00039337777777777777,
    0.0003914802469135802,
    0.00038958271604938274,
    0.0003876851851851852,
    0.00038578765432098765,
    0.00038389012345679016,
    0.00038199259259259256,
    0.00038009506172839507,
    0.00037819753086419753,
    0.0003763,
    0.0003744024691358025,
    0.00037250493827160495,
    0.0003706074074074074,
    0.0003687098765432099,
    0.0003668123456790123,
    0.00036491481481481483,
    0.0003630172839506173,
    0.00036111975308641975,
    0.00035922222222222226,
    0.00035732469135802466,
    0.00035542716049382717,
    0.0003535296296296296,
    0.0003516320987654321,
    0.0003497345679012346,
    0.00034783703703703705,
    0.0003459395061728395,
    0.000344041975308642,
    0.0003421444444444444,
    0.00034024691358024693,
    0.0003383493827160494,
    0.00033645185185185184,
    0.00033455432098765435,
    0.0003326567901234568,
    0.00033075925925925927,
    0.0003288617283950618,
    0.0003269641975308642,
    0.0003250666666666667,
    0.00032316913580246915,
    0.0003212716049382716,
    0.0003193740740740741,
    0.0003174765432098765,
    0.000315579012345679,
    0.0003136814814814815,
    0.00031178395061728394,
    0.00030988641975308645,
    0.0003079888888888889,
    0.00030609135802469136,
    0.0003041938271604939,
    0.0003022962962962963,
    0.0003003987654320988,
    0.00029850123456790124,
    0.0002966037037037037,
    0.0002947061728395062,
    0.00029280864197530867,
    0.0002909111111111111,
    0.00028901358024691363,
    0.00028711604938271604,
    0.00028521851851851855,
    0.000283320987654321,
    0.00028142345679012346,
    0.0002795259259259259,
    0.0002776283950617284,
    0.0002757308641975309,
    0.00027383333333333334,
    0.0002719358024691358,
    0.0002700382716049383,
    0.00026814074074074076,
    0.0002662432098765432,
    0.0002643456790123457,
    0.0002624481481481482,
    0.00026055061728395064,
    0.0002586530864197531,
    0.00025675555555555556,
    0.00025485802469135807,
    0.0002529604938271605,
    0.000251062962962963,
    0.00024916543209876544,
    0.00024726790123456795,
    0.0002453703703703704,
    0.00024347283950617286,
    0.00024157530864197532,
    0.00023967777777777777,
    0.00023778024691358028,
    0.00023588271604938274,
    0.0002339851851851852,
    0.00023208765432098765,
    0.00023019012345679016,
    0.00022829259259259262,
    0.00022639506172839508,
    0.00022449753086419753,
    0.00022260000000000004,
    0.0002207024691358025,
    0.00021880493827160496,
    0.0002169074074074074,
    0.00021500987654320992,
    0.00021311234567901238,
    0.00021121481481481484,
    0.0002093172839506173,
    0.0002074197530864198,
    0.00020552222222222226,
    0.00020362469135802472,
    0.00020172716049382717,
    0.00019982962962962963,
    0.00019793209876543214,
    0.0001960345679012346,
    0.00019413703703703705,
    0.0001922395061728395,
    0.00019034197530864202,
    0.00018844444444444448,
    0.00018654691358024693,
    0.0001846493827160494,
    0.0001827518518518519,
    0.00018085432098765436,
    0.00017895679012345681,
    0.00017705925925925927,
    0.00017516172839506178,
    0.00017326419753086424,
    0.0001713666666666667,
    0.00016946913580246915,
    0.00016757160493827166,
    0.00016567407407407412,
    0.00016377654320987657,
    0.00016187901234567903,
    0.0001599814814814815,
    0.000158083950617284,
    0.00015618641975308645,
    0.0001542888888888889,
    0.00015239135802469137,
    0.00015049382716049388,
    0.00014859629629629633,
    0.0001466987654320988,
    0.00014480123456790125,
    0.00014290370370370376,
    0.00014100617283950621,
    0.00013910864197530867,
    0.00013721111111111113,
    0.00013531358024691364,
    0.0001334160493827161,
    0.00013151851851851855,
    0.000129620987654321,
    0.00012772345679012352,
    0.00012582592592592597,
    0.00012392839506172843,
    0.00012203086419753089,
    0.00012013333333333334,
    0.00011823580246913585,
    0.00011633827160493831,
    0.00011444074074074077,
    0.00011254320987654322,
    0.00011064567901234573,
    0.00010874814814814819,
    0.00010685061728395065,
    0.0001049530864197531,
    0.00010305555555555562,
    0.00010115802469135807,
    9.926049382716053e-05,
    9.736296296296298e-05,
    9.54654320987655e-05,
    9.356790123456795e-05,
    9.167037037037041e-05,
    8.977283950617286e-05,
    8.787530864197538e-05,
    8.597777777777783e-05,
    8.408024691358029e-05,
    8.218271604938274e-05,
    8.02851851851852e-05,
    7.838765432098771e-05,
    7.649012345679017e-05,
    7.459259259259262e-05,
    7.269506172839508e-05,
    7.079753086419759e-05,
    6.890000000000005e-05,
    6.70024691358025e-05,
    6.510493827160496e-05,
    6.320740740740747e-05,
    6.130987654320993e-05,
    5.9412345679012385e-05,
    5.751481481481484e-05,
    5.561728395061735e-05,
    5.371975308641981e-05,
    5.1822222222222265e-05,
    4.992469135802472e-05,
    4.802716049382723e-05,
    4.612962962962969e-05,
    4.4232098765432145e-05,
    4.23345679012346e-05,
    4.043703703703711e-05,
    3.8539506172839515e-05,
    3.6641975308642025e-05,
    3.4744444444444536e-05,
    3.284691358024694e-05,
    3.094938271604945e-05,
    2.905185185185185e-05,
    2.7154320987654362e-05,
    2.5256790123456873e-05,
    2.3359259259259275e-05,
    2.1461728395061786e-05,
    1.9564197530864296e-05,
    1.76666666666667e-05,
    1.76666666666667e-05,
    1.7384180790960485e-05,
    1.7101694915254268e-05,
    1.6819209039548054e-05,
    1.6536723163841837e-05,
    1.6254237288135623e-05,
    1.5971751412429406e-05,
    1.5689265536723193e-05,
    1.5406779661016976e-05,
    1.5124293785310762e-05,
    1.4841807909604547e-05,
    1.4559322033898331e-05,
    1.4276836158192116e-05,
    1.39943502824859e-05,
    1.3711864406779687e-05,
    1.342937853107347e-05,
    1.3146892655367256e-05,
    1.2864406779661039e-05,
    1.2581920903954825e-05,
    1.229943502824861e-05,
    1.2016949152542395e-05,
    1.173446327683618e-05,
    1.1451977401129964e-05,
    1.1169491525423749e-05,
    1.0887005649717533e-05,
    1.060451977401132e-05,
    1.0322033898305102e-05,
    1.0039548022598889e-05,
    9.757062146892673e-06,
    9.474576271186458e-06,
    9.192090395480243e-06,
    8.909604519774027e-06,
    8.627118644067812e-06,
    8.344632768361597e-06,
    8.062146892655381e-06,
    7.779661016949166e-06,
    7.4971751412429506e-06,
    7.214689265536735e-06,
    6.9322033898305215e-06,
    6.649717514124306e-06,
    6.367231638418091e-06,
    6.0847457627118754e-06,
    5.80225988700566e-06,
    5.519774011299445e-06,
    5.237288135593229e-06,
    4.954802259887014e-06,
    4.672316384180799e-06,
    4.389830508474583e-06,
    4.107344632768368e-06,
    3.824858757062154e-06,
    3.542372881355939e-06,
    3.2598870056497235e-06,
    2.977401129943508e-06,
    2.6949152542372928e-06,
    2.4124293785310774e-06,
    2.129943502824862e-06,
    1.8474576271186484e-06,
    1.5649717514124313e-06,
    1.2824858757062176e-06,
    1e-06,
]
log = ["./returnn.log"]
log_batch_size = True
log_verbosity = 3
max_len_feature = 15
max_len_time = 20
max_reps_feature = 1
max_reps_time = 20
min_learning_rate = 1e-06
min_reps_feature = 0
min_reps_time = 0
model = "/u/mgunz/setups/2023-04--thesis-baselines/work/i6_core/returnn/rasr_training/ReturnnRasrTrainingJob.1vDpjG4XC7Ow/output/models/epoch"
n_contexts = 42
n_states_per_phone = 3
network = {
    "aux_006_center-output": {
        "class": "softmax",
        "from": "aux_006_linear2-diphone",
        "loss": "ce",
        "loss_opts": {"focal_loss_factor": 2.0},
        "loss_scale": 0.5,
        "n_out": 252,
        "target": "centerState",
    },
    "aux_006_length_masked": {
        "axis": "T",
        "class": "slice_nd",
        "from": ["aux_6_upsampled0"],
        "size": __time_tag__,
        "start": 0,
    },
    "aux_006_linear1-diphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "aux_006_length_masked",
        "n_out": 544,
    },
    "aux_006_linear1-leftContext": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "aux_006_length_masked",
        "n_out": 512,
    },
    "aux_006_linear1-triphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "aux_006_length_masked",
        "n_out": 672,
    },
    "aux_006_linear2-diphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "aux_006_linear1-diphone",
        "n_out": 544,
    },
    "aux_006_linear2-leftContext": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "aux_006_linear1-leftContext",
        "n_out": 512,
    },
    "aux_006_linear2-triphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "aux_006_linear1-triphone",
        "n_out": 672,
    },
    "aux_6_upsampled0": {
        "activation": "relu",
        "class": "transposed_conv",
        "filter_size": (3,),
        "from": ["enc_006"],
        "n_out": 512,
        "strides": (3,),
        "with_bias": True,
    },
    "center-output": {
        "class": "softmax",
        "from": "linear2-diphone",
        "loss": "ce",
        "loss_opts": {"focal_loss_factor": 2.0},
        "n_out": 252,
        "target": "centerState",
    },
    "centerPhoneme": {
        "class": "eval",
        "eval": "tf.math.floordiv(source(0), 3)",
        "from": "popWordEnd",
        "out_type": {"dim": 42, "dtype": "int32", "sparse": True},
    },
    "centerState": {
        "class": "eval",
        "eval": "tf.math.floordiv(source(0), 42)",
        "from": "popFutureLabel",
        "out_type": {"dim": 252, "dtype": "int32", "sparse": True},
        "register_as_extern_data": "centerState",
    },
    "conv0_0": {
        "activation": None,
        "class": "conv",
        "filter_size": (3, 3),
        "from": "source0",
        "in_spatial_dims": ["T", "dim:50"],
        "n_out": 32,
        "padding": "same",
        "with_bias": True,
    },
    "conv0_1": {
        "activation": "relu",
        "class": "conv",
        "filter_size": (3, 3),
        "from": "conv0_0",
        "in_spatial_dims": ["T", "dim:50"],
        "n_out": 32,
        "padding": "same",
        "with_bias": True,
    },
    "conv0p": {
        "class": "pool",
        "from": "conv0_1",
        "in_spatial_dims": ["T", "dim:50"],
        "mode": "max",
        "padding": "same",
        "pool_size": (1, 2),
        "strides": (1, 2),
    },
    "conv1_0": {
        "activation": None,
        "class": "conv",
        "filter_size": (3, 3),
        "from": "conv0p",
        "in_spatial_dims": ["T", "dim:25"],
        "n_out": 64,
        "padding": "same",
        "with_bias": True,
    },
    "conv1_1": {
        "activation": "relu",
        "class": "conv",
        "filter_size": (3, 3),
        "from": "conv1_0",
        "in_spatial_dims": ["T", "dim:25"],
        "n_out": 64,
        "padding": "same",
        "with_bias": True,
    },
    "conv1p": {
        "class": "pool",
        "from": "conv1_1",
        "in_spatial_dims": ["T", "dim:25"],
        "mode": "max",
        "padding": "same",
        "pool_size": (1, 1),
        "strides": (1, 1),
    },
    "conv_merged": {
        "axes": ["stag:conv0p:conv:s1", "dim:64"],
        "class": "merge_dims",
        "from": "conv1p",
    },
    "currentState": {
        "L2": 1e-06,
        "activation": None,
        "class": "linear",
        "from": "centerState",
        "n_out": 128,
        "with_bias": False,
    },
    "embedding": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["feature_stacking_merged"],
        "n_out": 512,
        "with_bias": True,
    },
    "embedding_dropout": {"class": "dropout", "dropout": 0.0, "from": ["embedding"]},
    "enc_001": {"class": "copy", "from": ["enc_001_ff2_out"]},
    "enc_001_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_001_conv_pointwise1"],
    },
    "enc_001_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_001_conv_layer_norm"],
    },
    "enc_001_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_001_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_001_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_001_conv_pointwise2"],
    },
    "enc_001_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_001_conv_depthwise"],
    },
    "enc_001_conv_laynorm": {"class": "layer_norm", "from": ["enc_001_self_att_out"]},
    "enc_001_conv_output": {
        "class": "combine",
        "from": ["enc_001_self_att_out", "enc_001_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_001_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_001_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_001_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_001_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_001_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_001_ff1_conv2"],
    },
    "enc_001_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_001_ff1_drop"],
    },
    "enc_001_ff1_laynorm": {"class": "layer_norm", "from": ["embedding_dropout"]},
    "enc_001_ff1_out": {
        "class": "combine",
        "from": ["embedding_dropout", "enc_001_ff1_drop_half"],
        "kind": "add",
    },
    "enc_001_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_001_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_001_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_001_ff2_conv2"],
    },
    "enc_001_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_001_ff2_drop"],
    },
    "enc_001_ff2_laynorm": {"class": "layer_norm", "from": ["enc_001_conv_output"]},
    "enc_001_ff2_out": {
        "class": "combine",
        "from": ["enc_001_conv_output", "enc_001_ff2_drop_half"],
        "kind": "add",
    },
    "enc_001_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_001_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_self_att_laynorm"],
        "key_shift": "enc_001_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_001_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_001_self_att_lin"],
    },
    "enc_001_self_att_laynorm": {"class": "layer_norm", "from": ["enc_001_ff1_out"]},
    "enc_001_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_001_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_001_self_att_out": {
        "class": "combine",
        "from": ["enc_001_ff1_out", "enc_001_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_002": {"class": "copy", "from": ["enc_002_ff2_out"]},
    "enc_002_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_002_conv_pointwise1"],
    },
    "enc_002_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_002_conv_layer_norm"],
    },
    "enc_002_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_002_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_002_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_002_conv_pointwise2"],
    },
    "enc_002_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_002_conv_depthwise"],
    },
    "enc_002_conv_laynorm": {"class": "layer_norm", "from": ["enc_002_self_att_out"]},
    "enc_002_conv_output": {
        "class": "combine",
        "from": ["enc_002_self_att_out", "enc_002_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_002_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_002_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_002_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_002_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_002_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_002_ff1_conv2"],
    },
    "enc_002_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_002_ff1_drop"],
    },
    "enc_002_ff1_laynorm": {"class": "layer_norm", "from": ["enc_001"]},
    "enc_002_ff1_out": {
        "class": "combine",
        "from": ["enc_001", "enc_002_ff1_drop_half"],
        "kind": "add",
    },
    "enc_002_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_002_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_002_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_002_ff2_conv2"],
    },
    "enc_002_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_002_ff2_drop"],
    },
    "enc_002_ff2_laynorm": {"class": "layer_norm", "from": ["enc_002_conv_output"]},
    "enc_002_ff2_out": {
        "class": "combine",
        "from": ["enc_002_conv_output", "enc_002_ff2_drop_half"],
        "kind": "add",
    },
    "enc_002_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_002_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_self_att_laynorm"],
        "key_shift": "enc_002_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_002_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_002_self_att_lin"],
    },
    "enc_002_self_att_laynorm": {"class": "layer_norm", "from": ["enc_002_ff1_out"]},
    "enc_002_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_002_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_002_self_att_out": {
        "class": "combine",
        "from": ["enc_002_ff1_out", "enc_002_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_003": {"class": "copy", "from": ["enc_003_ff2_out"]},
    "enc_003_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_003_conv_pointwise1"],
    },
    "enc_003_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_003_conv_layer_norm"],
    },
    "enc_003_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_003_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_003_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_003_conv_pointwise2"],
    },
    "enc_003_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_003_conv_depthwise"],
    },
    "enc_003_conv_laynorm": {"class": "layer_norm", "from": ["enc_003_self_att_out"]},
    "enc_003_conv_output": {
        "class": "combine",
        "from": ["enc_003_self_att_out", "enc_003_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_003_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_003_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_003_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_003_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_003_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_003_ff1_conv2"],
    },
    "enc_003_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_003_ff1_drop"],
    },
    "enc_003_ff1_laynorm": {"class": "layer_norm", "from": ["enc_002"]},
    "enc_003_ff1_out": {
        "class": "combine",
        "from": ["enc_002", "enc_003_ff1_drop_half"],
        "kind": "add",
    },
    "enc_003_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_003_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_003_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_003_ff2_conv2"],
    },
    "enc_003_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_003_ff2_drop"],
    },
    "enc_003_ff2_laynorm": {"class": "layer_norm", "from": ["enc_003_conv_output"]},
    "enc_003_ff2_out": {
        "class": "combine",
        "from": ["enc_003_conv_output", "enc_003_ff2_drop_half"],
        "kind": "add",
    },
    "enc_003_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_003_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_self_att_laynorm"],
        "key_shift": "enc_003_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_003_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_003_self_att_lin"],
    },
    "enc_003_self_att_laynorm": {"class": "layer_norm", "from": ["enc_003_ff1_out"]},
    "enc_003_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_003_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_003_self_att_out": {
        "class": "combine",
        "from": ["enc_003_ff1_out", "enc_003_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_004": {"class": "copy", "from": ["enc_004_ff2_out"]},
    "enc_004_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_004_conv_pointwise1"],
    },
    "enc_004_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_004_conv_layer_norm"],
    },
    "enc_004_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_004_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_004_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_004_conv_pointwise2"],
    },
    "enc_004_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_004_conv_depthwise"],
    },
    "enc_004_conv_laynorm": {"class": "layer_norm", "from": ["enc_004_self_att_out"]},
    "enc_004_conv_output": {
        "class": "combine",
        "from": ["enc_004_self_att_out", "enc_004_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_004_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_004_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_004_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_004_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_004_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_004_ff1_conv2"],
    },
    "enc_004_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_004_ff1_drop"],
    },
    "enc_004_ff1_laynorm": {"class": "layer_norm", "from": ["enc_003"]},
    "enc_004_ff1_out": {
        "class": "combine",
        "from": ["enc_003", "enc_004_ff1_drop_half"],
        "kind": "add",
    },
    "enc_004_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_004_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_004_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_004_ff2_conv2"],
    },
    "enc_004_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_004_ff2_drop"],
    },
    "enc_004_ff2_laynorm": {"class": "layer_norm", "from": ["enc_004_conv_output"]},
    "enc_004_ff2_out": {
        "class": "combine",
        "from": ["enc_004_conv_output", "enc_004_ff2_drop_half"],
        "kind": "add",
    },
    "enc_004_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_004_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_self_att_laynorm"],
        "key_shift": "enc_004_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_004_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_004_self_att_lin"],
    },
    "enc_004_self_att_laynorm": {"class": "layer_norm", "from": ["enc_004_ff1_out"]},
    "enc_004_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_004_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_004_self_att_out": {
        "class": "combine",
        "from": ["enc_004_ff1_out", "enc_004_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_005": {"class": "copy", "from": ["enc_005_ff2_out"]},
    "enc_005_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_005_conv_pointwise1"],
    },
    "enc_005_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_005_conv_layer_norm"],
    },
    "enc_005_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_005_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_005_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_005_conv_pointwise2"],
    },
    "enc_005_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_005_conv_depthwise"],
    },
    "enc_005_conv_laynorm": {"class": "layer_norm", "from": ["enc_005_self_att_out"]},
    "enc_005_conv_output": {
        "class": "combine",
        "from": ["enc_005_self_att_out", "enc_005_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_005_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_005_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_005_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_005_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_005_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_005_ff1_conv2"],
    },
    "enc_005_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_005_ff1_drop"],
    },
    "enc_005_ff1_laynorm": {"class": "layer_norm", "from": ["enc_004"]},
    "enc_005_ff1_out": {
        "class": "combine",
        "from": ["enc_004", "enc_005_ff1_drop_half"],
        "kind": "add",
    },
    "enc_005_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_005_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_005_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_005_ff2_conv2"],
    },
    "enc_005_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_005_ff2_drop"],
    },
    "enc_005_ff2_laynorm": {"class": "layer_norm", "from": ["enc_005_conv_output"]},
    "enc_005_ff2_out": {
        "class": "combine",
        "from": ["enc_005_conv_output", "enc_005_ff2_drop_half"],
        "kind": "add",
    },
    "enc_005_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_005_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_self_att_laynorm"],
        "key_shift": "enc_005_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_005_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_005_self_att_lin"],
    },
    "enc_005_self_att_laynorm": {"class": "layer_norm", "from": ["enc_005_ff1_out"]},
    "enc_005_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_005_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_005_self_att_out": {
        "class": "combine",
        "from": ["enc_005_ff1_out", "enc_005_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_006": {"class": "copy", "from": ["enc_006_ff2_out"]},
    "enc_006_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_006_conv_pointwise1"],
    },
    "enc_006_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_006_conv_layer_norm"],
    },
    "enc_006_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_006_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_006_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_006_conv_pointwise2"],
    },
    "enc_006_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_006_conv_depthwise"],
    },
    "enc_006_conv_laynorm": {"class": "layer_norm", "from": ["enc_006_self_att_out"]},
    "enc_006_conv_output": {
        "class": "combine",
        "from": ["enc_006_self_att_out", "enc_006_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_006_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_006_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_006_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_006_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_006_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_006_ff1_conv2"],
    },
    "enc_006_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_006_ff1_drop"],
    },
    "enc_006_ff1_laynorm": {"class": "layer_norm", "from": ["enc_005"]},
    "enc_006_ff1_out": {
        "class": "combine",
        "from": ["enc_005", "enc_006_ff1_drop_half"],
        "kind": "add",
    },
    "enc_006_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_006_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_006_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_006_ff2_conv2"],
    },
    "enc_006_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_006_ff2_drop"],
    },
    "enc_006_ff2_laynorm": {"class": "layer_norm", "from": ["enc_006_conv_output"]},
    "enc_006_ff2_out": {
        "class": "combine",
        "from": ["enc_006_conv_output", "enc_006_ff2_drop_half"],
        "kind": "add",
    },
    "enc_006_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_006_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_self_att_laynorm"],
        "key_shift": "enc_006_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_006_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_006_self_att_lin"],
    },
    "enc_006_self_att_laynorm": {"class": "layer_norm", "from": ["enc_006_ff1_out"]},
    "enc_006_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_006_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_006_self_att_out": {
        "class": "combine",
        "from": ["enc_006_ff1_out", "enc_006_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_007": {"class": "copy", "from": ["enc_007_ff2_out"]},
    "enc_007_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_007_conv_pointwise1"],
    },
    "enc_007_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_007_conv_layer_norm"],
    },
    "enc_007_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_007_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_007_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_007_conv_pointwise2"],
    },
    "enc_007_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_007_conv_depthwise"],
    },
    "enc_007_conv_laynorm": {"class": "layer_norm", "from": ["enc_007_self_att_out"]},
    "enc_007_conv_output": {
        "class": "combine",
        "from": ["enc_007_self_att_out", "enc_007_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_007_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_007_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_007_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_007_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_007_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_007_ff1_conv2"],
    },
    "enc_007_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_007_ff1_drop"],
    },
    "enc_007_ff1_laynorm": {"class": "layer_norm", "from": ["enc_006"]},
    "enc_007_ff1_out": {
        "class": "combine",
        "from": ["enc_006", "enc_007_ff1_drop_half"],
        "kind": "add",
    },
    "enc_007_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_007_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_007_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_007_ff2_conv2"],
    },
    "enc_007_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_007_ff2_drop"],
    },
    "enc_007_ff2_laynorm": {"class": "layer_norm", "from": ["enc_007_conv_output"]},
    "enc_007_ff2_out": {
        "class": "combine",
        "from": ["enc_007_conv_output", "enc_007_ff2_drop_half"],
        "kind": "add",
    },
    "enc_007_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_007_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_self_att_laynorm"],
        "key_shift": "enc_007_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_007_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_007_self_att_lin"],
    },
    "enc_007_self_att_laynorm": {"class": "layer_norm", "from": ["enc_007_ff1_out"]},
    "enc_007_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_007_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_007_self_att_out": {
        "class": "combine",
        "from": ["enc_007_ff1_out", "enc_007_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_008": {"class": "copy", "from": ["enc_008_ff2_out"]},
    "enc_008_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_008_conv_pointwise1"],
    },
    "enc_008_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_008_conv_layer_norm"],
    },
    "enc_008_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_008_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_008_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_008_conv_pointwise2"],
    },
    "enc_008_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_008_conv_depthwise"],
    },
    "enc_008_conv_laynorm": {"class": "layer_norm", "from": ["enc_008_self_att_out"]},
    "enc_008_conv_output": {
        "class": "combine",
        "from": ["enc_008_self_att_out", "enc_008_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_008_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_008_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_008_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_008_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_008_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_008_ff1_conv2"],
    },
    "enc_008_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_008_ff1_drop"],
    },
    "enc_008_ff1_laynorm": {"class": "layer_norm", "from": ["enc_007"]},
    "enc_008_ff1_out": {
        "class": "combine",
        "from": ["enc_007", "enc_008_ff1_drop_half"],
        "kind": "add",
    },
    "enc_008_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_008_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_008_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_008_ff2_conv2"],
    },
    "enc_008_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_008_ff2_drop"],
    },
    "enc_008_ff2_laynorm": {"class": "layer_norm", "from": ["enc_008_conv_output"]},
    "enc_008_ff2_out": {
        "class": "combine",
        "from": ["enc_008_conv_output", "enc_008_ff2_drop_half"],
        "kind": "add",
    },
    "enc_008_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_008_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_self_att_laynorm"],
        "key_shift": "enc_008_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_008_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_008_self_att_lin"],
    },
    "enc_008_self_att_laynorm": {"class": "layer_norm", "from": ["enc_008_ff1_out"]},
    "enc_008_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_008_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_008_self_att_out": {
        "class": "combine",
        "from": ["enc_008_ff1_out", "enc_008_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_009": {"class": "copy", "from": ["enc_009_ff2_out"]},
    "enc_009_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_009_conv_pointwise1"],
    },
    "enc_009_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_009_conv_layer_norm"],
    },
    "enc_009_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_009_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_009_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_009_conv_pointwise2"],
    },
    "enc_009_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_009_conv_depthwise"],
    },
    "enc_009_conv_laynorm": {"class": "layer_norm", "from": ["enc_009_self_att_out"]},
    "enc_009_conv_output": {
        "class": "combine",
        "from": ["enc_009_self_att_out", "enc_009_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_009_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_009_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_009_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_009_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_009_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_009_ff1_conv2"],
    },
    "enc_009_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_009_ff1_drop"],
    },
    "enc_009_ff1_laynorm": {"class": "layer_norm", "from": ["enc_008"]},
    "enc_009_ff1_out": {
        "class": "combine",
        "from": ["enc_008", "enc_009_ff1_drop_half"],
        "kind": "add",
    },
    "enc_009_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_009_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_009_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_009_ff2_conv2"],
    },
    "enc_009_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_009_ff2_drop"],
    },
    "enc_009_ff2_laynorm": {"class": "layer_norm", "from": ["enc_009_conv_output"]},
    "enc_009_ff2_out": {
        "class": "combine",
        "from": ["enc_009_conv_output", "enc_009_ff2_drop_half"],
        "kind": "add",
    },
    "enc_009_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_009_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_self_att_laynorm"],
        "key_shift": "enc_009_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_009_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_009_self_att_lin"],
    },
    "enc_009_self_att_laynorm": {"class": "layer_norm", "from": ["enc_009_ff1_out"]},
    "enc_009_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_009_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_009_self_att_out": {
        "class": "combine",
        "from": ["enc_009_ff1_out", "enc_009_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_010": {"class": "copy", "from": ["enc_010_ff2_out"]},
    "enc_010_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_010_conv_pointwise1"],
    },
    "enc_010_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_010_conv_layer_norm"],
    },
    "enc_010_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_010_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_010_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_010_conv_pointwise2"],
    },
    "enc_010_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_010_conv_depthwise"],
    },
    "enc_010_conv_laynorm": {"class": "layer_norm", "from": ["enc_010_self_att_out"]},
    "enc_010_conv_output": {
        "class": "combine",
        "from": ["enc_010_self_att_out", "enc_010_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_010_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_010_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_010_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_010_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_010_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_010_ff1_conv2"],
    },
    "enc_010_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_010_ff1_drop"],
    },
    "enc_010_ff1_laynorm": {"class": "layer_norm", "from": ["enc_009"]},
    "enc_010_ff1_out": {
        "class": "combine",
        "from": ["enc_009", "enc_010_ff1_drop_half"],
        "kind": "add",
    },
    "enc_010_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_010_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_010_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_010_ff2_conv2"],
    },
    "enc_010_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_010_ff2_drop"],
    },
    "enc_010_ff2_laynorm": {"class": "layer_norm", "from": ["enc_010_conv_output"]},
    "enc_010_ff2_out": {
        "class": "combine",
        "from": ["enc_010_conv_output", "enc_010_ff2_drop_half"],
        "kind": "add",
    },
    "enc_010_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_010_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_self_att_laynorm"],
        "key_shift": "enc_010_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_010_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_010_self_att_lin"],
    },
    "enc_010_self_att_laynorm": {"class": "layer_norm", "from": ["enc_010_ff1_out"]},
    "enc_010_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_010_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_010_self_att_out": {
        "class": "combine",
        "from": ["enc_010_ff1_out", "enc_010_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_011": {"class": "copy", "from": ["enc_011_ff2_out"]},
    "enc_011_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_011_conv_pointwise1"],
    },
    "enc_011_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_011_conv_layer_norm"],
    },
    "enc_011_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_011_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_011_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_011_conv_pointwise2"],
    },
    "enc_011_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_011_conv_depthwise"],
    },
    "enc_011_conv_laynorm": {"class": "layer_norm", "from": ["enc_011_self_att_out"]},
    "enc_011_conv_output": {
        "class": "combine",
        "from": ["enc_011_self_att_out", "enc_011_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_011_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_011_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_011_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_011_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_011_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_011_ff1_conv2"],
    },
    "enc_011_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_011_ff1_drop"],
    },
    "enc_011_ff1_laynorm": {"class": "layer_norm", "from": ["enc_010"]},
    "enc_011_ff1_out": {
        "class": "combine",
        "from": ["enc_010", "enc_011_ff1_drop_half"],
        "kind": "add",
    },
    "enc_011_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_011_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_011_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_011_ff2_conv2"],
    },
    "enc_011_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_011_ff2_drop"],
    },
    "enc_011_ff2_laynorm": {"class": "layer_norm", "from": ["enc_011_conv_output"]},
    "enc_011_ff2_out": {
        "class": "combine",
        "from": ["enc_011_conv_output", "enc_011_ff2_drop_half"],
        "kind": "add",
    },
    "enc_011_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_011_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_self_att_laynorm"],
        "key_shift": "enc_011_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_011_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_011_self_att_lin"],
    },
    "enc_011_self_att_laynorm": {"class": "layer_norm", "from": ["enc_011_ff1_out"]},
    "enc_011_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_011_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_011_self_att_out": {
        "class": "combine",
        "from": ["enc_011_ff1_out", "enc_011_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_012": {"class": "copy", "from": ["enc_012_ff2_out"]},
    "enc_012_conv_GLU": {
        "activation": "identity",
        "class": "gating",
        "from": ["enc_012_conv_pointwise1"],
    },
    "enc_012_conv_act": {
        "activation": "swish",
        "class": "activation",
        "from": ["enc_012_conv_layer_norm"],
    },
    "enc_012_conv_depthwise": {
        "activation": None,
        "class": "conv",
        "filter_size": (32,),
        "from": ["enc_012_conv_GLU"],
        "groups": 512,
        "n_out": 512,
        "padding": "same",
        "with_bias": True,
    },
    "enc_012_conv_dropout": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_012_conv_pointwise2"],
    },
    "enc_012_conv_layer_norm": {
        "class": "layer_norm",
        "from": ["enc_012_conv_depthwise"],
    },
    "enc_012_conv_laynorm": {"class": "layer_norm", "from": ["enc_012_self_att_out"]},
    "enc_012_conv_output": {
        "class": "combine",
        "from": ["enc_012_self_att_out", "enc_012_conv_dropout"],
        "kind": "add",
        "n_out": 512,
    },
    "enc_012_conv_pointwise1": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_conv_laynorm"],
        "n_out": 1024,
        "with_bias": False,
    },
    "enc_012_conv_pointwise2": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_conv_act"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_012_ff1_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_ff1_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_012_ff1_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_ff1_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_012_ff1_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_012_ff1_conv2"],
    },
    "enc_012_ff1_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_012_ff1_drop"],
    },
    "enc_012_ff1_laynorm": {"class": "layer_norm", "from": ["enc_011"]},
    "enc_012_ff1_out": {
        "class": "combine",
        "from": ["enc_011", "enc_012_ff1_drop_half"],
        "kind": "add",
    },
    "enc_012_ff2_conv1": {
        "activation": "swish",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_ff2_laynorm"],
        "n_out": 2048,
        "with_bias": True,
    },
    "enc_012_ff2_conv2": {
        "activation": None,
        "class": "linear",
        "dropout": 0.1,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_ff2_conv1"],
        "n_out": 512,
        "with_bias": True,
    },
    "enc_012_ff2_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_012_ff2_conv2"],
    },
    "enc_012_ff2_drop_half": {
        "class": "eval",
        "eval": "0.5 * source(0)",
        "from": ["enc_012_ff2_drop"],
    },
    "enc_012_ff2_laynorm": {"class": "layer_norm", "from": ["enc_012_conv_output"]},
    "enc_012_ff2_out": {
        "class": "combine",
        "from": ["enc_012_conv_output", "enc_012_ff2_drop_half"],
        "kind": "add",
    },
    "enc_012_rel_pos": {
        "class": "relative_positional_encoding",
        "clipping": 400,
        "fixed": False,
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_self_att_laynorm"],
        "n_out": 64,
    },
    "enc_012_self_att_att": {
        "attention_dropout": 0.1,
        "attention_left_only": False,
        "class": "self_attention",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_self_att_laynorm"],
        "key_shift": "enc_012_rel_pos",
        "n_out": 512,
        "num_heads": 8,
        "total_key_dim": 512,
    },
    "enc_012_self_att_drop": {
        "class": "dropout",
        "dropout": 0.1,
        "from": ["enc_012_self_att_lin"],
    },
    "enc_012_self_att_laynorm": {"class": "layer_norm", "from": ["enc_012_ff1_out"]},
    "enc_012_self_att_lin": {
        "activation": None,
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["enc_012_self_att_att"],
        "n_out": 512,
        "with_bias": False,
    },
    "enc_012_self_att_out": {
        "class": "combine",
        "from": ["enc_012_ff1_out", "enc_012_self_att_drop"],
        "kind": "add",
        "n_out": 512,
    },
    "encoder": {"class": "layer_norm", "from": ["enc_012"]},
    "encoder-output": {"class": "copy", "from": "length_masked"},
    "feature_stacking_merged": {
        "axes": (2, 3),
        "class": "merge_dims",
        "from": ["feature_stacking_window"],
    },
    "feature_stacking_window": {
        "class": "window",
        "from": ["conv_merged"],
        "stride": 3,
        "window_left": 2,
        "window_right": 0,
        "window_size": 3,
    },
    "futureLabel": {
        "class": "eval",
        "eval": "tf.math.floormod(source(0), 42)",
        "from": "data:classes",
        "out_type": {"dim": 42, "dtype": "int32", "sparse": True},
        "register_as_extern_data": "futureLabel",
    },
    "left-output": {
        "class": "softmax",
        "from": "linear2-leftContext",
        "loss": "ce",
        "loss_opts": {"focal_loss_factor": 2.0},
        "n_out": 42,
        "target": "pastLabel",
    },
    "length_masked": {
        "axis": "T",
        "class": "slice_nd",
        "from": ["upsampled0"],
        "size": __time_tag__,
        "start": 0,
    },
    "linear1-diphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["encoder-output", "pastEmbed"],
        "n_out": 544,
    },
    "linear1-leftContext": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "encoder-output",
        "n_out": 512,
    },
    "linear1-triphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": ["encoder-output", "currentState", "pastEmbed"],
        "n_out": 672,
    },
    "linear2-diphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "linear1-diphone",
        "n_out": 544,
    },
    "linear2-leftContext": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "linear1-leftContext",
        "n_out": 512,
    },
    "linear2-triphone": {
        "L2": 1e-06,
        "activation": "relu",
        "class": "linear",
        "forward_weights_init": "variance_scaling_initializer(mode='fan_in', distribution='uniform', scale=0.78)",
        "from": "linear1-triphone",
        "n_out": 672,
    },
    "pastEmbed": {
        "L2": 1e-06,
        "activation": None,
        "class": "linear",
        "from": "pastLabel",
        "n_out": 32,
        "with_bias": False,
    },
    "pastLabel": {
        "class": "eval",
        "eval": "tf.math.floormod(source(0), 42)",
        "from": "popFutureLabel",
        "out_type": {"dim": 42, "dtype": "int32", "sparse": True},
        "register_as_extern_data": "pastLabel",
    },
    "popFutureLabel": {
        "class": "eval",
        "eval": "tf.math.floordiv(source(0), 42)",
        "from": "data:classes",
        "out_type": {"dim": 10584, "dtype": "int32", "sparse": True},
    },
    "popWordEnd": {
        "class": "eval",
        "eval": "tf.math.floordiv(source(0), 2)",
        "from": "centerState",
        "out_type": {"dim": 126, "dtype": "int32", "sparse": True},
    },
    "right-output": {
        "class": "softmax",
        "from": "linear2-triphone",
        "loss": "ce",
        "loss_opts": {"focal_loss_factor": 2.0},
        "n_out": 42,
        "target": "futureLabel",
    },
    "source": {
        "class": "eval",
        "eval": "self.network.get_config().typed_value('transform')(source(0), network=self.network)",
        "from": "data",
    },
    "source0": {
        "axis": "F",
        "class": "split_dims",
        "dims": (-1, 1),
        "from": ["source"],
    },
    "stateId": {
        "class": "eval",
        "eval": "tf.math.floormod(source(0), 3)",
        "from": "popWordEnd",
        "out_type": {"dim": 3, "dtype": "int32", "sparse": True},
    },
    "upsampled0": {
        "activation": "relu",
        "class": "transposed_conv",
        "filter_size": (3,),
        "from": ["encoder"],
        "n_out": 512,
        "strides": (3,),
        "with_bias": True,
    },
    "wordEndClass": {
        "class": "eval",
        "eval": "tf.math.floormod(source(0), 2)",
        "from": "centerState",
        "out_type": {"dim": 2, "dtype": "int32", "sparse": True},
    },
}
num_epochs = 600
num_input = 50
optimizer = {"class": "nadam"}
optimizer_epsilon = 1e-08
save_interval = 1
target = "classes"
task = "train"
tf_log_memory_usage = True
train = {
    "class": "ExternSprintDataset",
    "partitionEpoch": 40,
    "sprintConfigStr": "--config=rasr.train.config --*.LOGFILE=nn-trainer.train.log --*.TASK=1",
    "sprintTrainerExecPath": "/u/mgunz/src/fh_rasr/arch/linux-x86_64-standard/nn-trainer.linux-x86_64-standard",
}
update_on_device = True
use_tensorflow = True
window = 1
config = {}

locals().update(**config)


def mask(x, axis, pos, max_amount):
    """
    :param tf.Tensor x: (batch,time,feature)
    :param int axis:
    :param tf.Tensor pos: (batch,)
    :param int max_amount: inclusive
    """
    import tensorflow as tf

    ndim = x.get_shape().ndims
    n_batch = tf.shape(x)[0]
    dim = tf.shape(x)[axis]
    # amount = tf.random_uniform(shape=(n_batch,), minval=1, maxval=max_amount + 1, dtype=tf.int32)
    amount = tf.random.uniform(
        shape=(n_batch,), minval=1, maxval=max_amount + 1, dtype=tf.int32
    )
    pos2 = tf.minimum(pos + amount, dim)
    idxs = tf.expand_dims(tf.range(0, dim), 0)  # (1,dim)
    pos_bc = tf.expand_dims(pos, 1)  # (batch,1)
    pos2_bc = tf.expand_dims(pos2, 1)  # (batch,1)
    cond = tf.logical_and(
        tf.greater_equal(idxs, pos_bc), tf.less(idxs, pos2_bc)
    )  # (batch,dim)
    cond = tf.reshape(
        cond, [tf.shape(x)[i] if i in (0, axis) else 1 for i in range(ndim)]
    )
    from TFUtil import where_bc

    x = where_bc(cond, 0.0, x)
    return x


def random_mask(x, axis, min_num, max_num, max_dims):
    """
    :param tf.Tensor x: (batch,time,feature)
    :param int axis:
    :param int|tf.Tensor min_num:
    :param int|tf.Tensor max_num: inclusive
    :param int max_dims: inclusive
    """
    import tensorflow as tf

    n_batch = tf.shape(x)[0]
    # num = tf.random_uniform(shape=(n_batch,), minval=min_num, maxval=max_num + 1, dtype=tf.int32)
    num = tf.random.uniform(
        shape=(n_batch,), minval=min_num, maxval=max_num + 1, dtype=tf.int32
    )
    # https://github.com/tensorflow/tensorflow/issues/9260
    # https://timvieira.github.io/blog/post/2014/08/01/gumbel-max-trick-and-weighted-reservoir-sampling/
    # z = -tf.log(-tf.log(tf.random_uniform((n_batch, tf.shape(x)[axis]), 0, 1)))
    z = -tf.math.log(
        -tf.math.log(tf.random.uniform((n_batch, tf.shape(x)[axis]), 0, 1))
    )

    ## if the time axis dim. is smaller than maxval - 1
    # num = tf.cond(tf.less(tf.shape(x)[axis], max_num), lambda: tf.random_uniform(shape=(n_batch,), minval=min_num, maxval=tf.shape(x)[axis] + 1, dtype=tf.int32), lambda: num)
    num = tf.cond(
        tf.less(tf.shape(x)[axis], max_num),
        lambda: tf.random.uniform(
            shape=(n_batch,),
            minval=min_num,
            maxval=tf.shape(x)[axis] + 1,
            dtype=tf.int32,
        ),
        lambda: num,
    )

    _, indices = tf.nn.top_k(z, tf.reduce_max(num))
    # indices should be sorted, and of shape (batch,num), entries (int32) in [0,dim)
    # indices = tf.Print(indices, ["indices", indices, tf.shape(indices)])
    _, x = tf.while_loop(
        cond=lambda i, _: tf.less(i, tf.reduce_max(num)),
        body=lambda i, x: (
            i + 1,
            tf.compat.v1.where(
                tf.less(i, num),
                mask(x, axis=axis, pos=indices[:, i], max_amount=max_dims),
                x,
            ),
        ),
        loop_vars=(0, x),
    )
    return x


def summary(name, x):
    """
    :param str name:
    :param tf.Tensor x: (batch,time,feature)
    """
    import tensorflow as tf

    # tf.summary.image wants [batch_size, height,  width, channels],
    # we have (batch, time, feature).
    img = tf.expand_dims(x, axis=3)  # (batch,time,feature,1)
    img = tf.transpose(img, [0, 2, 1, 3])  # (batch,feature,time,1)
    tf.summary.image(name, img, max_outputs=10)
    tf.summary.scalar("%s_max_abs" % name, tf.reduce_max(tf.abs(x)))
    mean = tf.reduce_mean(x)
    tf.summary.scalar("%s_mean" % name, mean)
    stddev = tf.sqrt(tf.reduce_mean(tf.square(x - mean)))
    tf.summary.scalar("%s_stddev" % name, stddev)
    tf.summary.histogram("%s_hist" % name, tf.reduce_max(tf.abs(x), axis=2))


def transform(x, network):
    import tensorflow as tf

    # summary("features", x)
    # x = tf.clip_by_value(x, -3.0, 3.0)
    # summary("features_clip", x)

    max_reps_time = network.get_config().typed_value("max_reps_time")
    min_reps_time = network.get_config().typed_value("min_reps_time")
    max_reps_feature = network.get_config().typed_value("max_reps_feature")
    min_reps_feature = network.get_config().typed_value("min_reps_feature")

    max_len_time = network.get_config().typed_value("max_len_time")
    max_len_feature = network.get_config().typed_value("max_len_feature")

    # number of repetitions for time masking
    if max_reps_time is None:
        max_reps_time = tf.maximum(
            tf.shape(x)[1] // (max_len_time or 20), 1
        )  # // 100, 1)
    if min_reps_time is None:
        min_reps_time = 1

    # number of repetitions for feature masking
    if max_reps_feature is None:
        max_reps_feature = 2
    if min_reps_feature is None:
        min_reps_feature = 1

    # length of time masking
    if max_len_time is None:
        max_len_time = 20
    # length of feature masking
    if max_len_feature is None:
        max_len_feature = tf.shape(x)[-1] // 5

    def get_masked():
        x_masked = x
        x_masked = random_mask(
            x_masked,
            axis=1,
            min_num=min_reps_time,
            max_num=max_reps_time,
            max_dims=max_len_time,
        )
        x_masked = random_mask(
            x_masked,
            axis=2,
            min_num=min_reps_feature,
            max_num=max_reps_feature,
            max_dims=max_len_feature,
        )
        # summary("features_mask", x_masked)
        return x_masked

    x = network.cond_on_train(get_masked, lambda: x)

    return x
